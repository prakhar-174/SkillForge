<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Proctor Test</title>
<style>
body{background:#111;color:#0f0;font-family:Arial;padding:20px}
video{width:320px;border:2px solid #0f0}
#log{background:#000;height:220px;overflow-y:auto;padding:10px;margin-top:10px}
</style>
</head>
<body>

<h2>Proctoring Test</h2>
<video id="video" autoplay muted></video>
<div id="log"></div>

<script>
const BASE="http://127.0.0.1:8000/api/"
const LOGIN=BASE+"auth/login/"
const LIST=BASE+"list/"
const START=BASE+"start/"
const EVENT=BASE+"event/"

const USER="testuser"
const PASS="test@123"

let TOKEN=null
let SESSION=null

function log(m){
  let d=document.getElementById("log")
  d.innerHTML+=m+"<br>"
  d.scrollTop=d.scrollHeight
}

function headers(){
  return{
    "Authorization":"Bearer "+TOKEN,
    "Content-Type":"application/json"
  }
}

function sleep(ms){
  return new Promise(r=>setTimeout(r,ms))
}

async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true})
    document.getElementById("video").srcObject=stream
    log("camera granted")
    await sleep(2000)
    log("camera ready")
  }catch{
    log("camera denied")
  }
}

async function login(){
  let r=await fetch(LOGIN,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:USER,password:PASS})
  })
  let j=await r.json()
  TOKEN=j.access || j.tokens.access
  log("login ok")
}

async function getExam(){
  let r=await fetch(LIST,{headers:headers()})
  let j=await r.json()
  log("exams="+JSON.stringify(j))
  if(!j.length){
    log("no exam found")
    return null
  }
  return j[0].id
}

async function startExam(id){
  let r=await fetch(START,{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({exam_id:id})
  })
  let j=await r.json()
  SESSION=j.session_id
  log("session started="+SESSION)
}

function sendEvent(t,c=1){
  log("event="+t)
  if(!SESSION){
    log("session not ready")
    return
  }
  fetch(EVENT,{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({
      session_id:SESSION,
      event_type:t,
      confidence:c
    })
  })
  .then(r=>r.json())
  .then(j=>log("risk="+j.risk))
}

document.addEventListener("visibilitychange",()=>{
  if(document.hidden)sendEvent("TAB_SWITCH")
})

window.addEventListener("blur",()=>{
  sendEvent("TAB_SWITCH",0.8)
})

setInterval(()=>{
  sendEvent("NO_FACE",0.5)
},20000)

;(async()=>{
  await startCamera()
  await login()
  let id=await getExam()
  if(!id)return
  await startExam(id)
  log("proctoring active")
})()
</script>

</body>
</html>
